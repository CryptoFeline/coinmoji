<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinmoji Visual Test - Client vs Server Rendering</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.155.0/three.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #ffffff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: cente            document.getElementById('serverToneMapping').checked = true; // CLIENT NOW HAS TONE MAPPING TOO
            document.getElementById('serverToneMappingExposure').value = '0.8';
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .viewport {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .viewport h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #00eaff;
        }
        
        .canvas-container {
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            display: inline-block;
        }
        
        .controls {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
        
        .control-group h4 {
            margin: 0 0 10px 0;
            color: #00eaff;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 8px 0;
        }
        
        label {
            font-size: 12px;
            color: #cccccc;
            min-width: 100px;
        }
        
        input[type="range"] {
            flex: 1;
            margin: 0 10px;
        }
        
        input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 5px;
        }
        
        select {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 5px;
            padding: 5px;
        }
        
        .value {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
            color: #00eaff;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(45deg, #00eaff, #ee00ff);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            margin-top: 20px;
        }
        
        .highlight {
            background: rgba(255, 193, 7, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
            border-left: 3px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¯ Coinmoji Visual Test - Client vs Server</h1>
            <p>Compare CLIENT (CoinEditor.tsx) vs SERVER (render-frames.ts) rendering side-by-side</p>
            <div style="background: rgba(255,193,7,0.1); padding: 10px; border-radius: 8px; margin-top: 15px;">
                <h4 style="color: #ffc107; margin: 0 0 8px 0;">Key Differences:</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
                    <div>
                        <strong>CLIENT (Left):</strong><br>
                        â€¢ Fill Light: 0.8 (fixed)<br>
                        â€¢ Ambient Light: 0.9 (fixed)<br>
                        â€¢ Camera Z: 6<br>
                        â€¢ Tone Mapping: Linear + 0.8 exposure<br>
                        â€¢ <span style="color: #ffc107;">Metalness: 1.0 (when metallic)</span>
                    </div>
                    <div>
                        <strong>SERVER (Right):</strong><br>
                        â€¢ Fill Light: 0.6 (adjustable)<br>
                        â€¢ Ambient Light: 0.7 (adjustable)<br>
                        â€¢ Camera Z: 2.8<br>
                        â€¢ Tone Mapping: Linear + 0.8 exposure<br>
                        â€¢ <span style="color: #ffc107;">Metalness: 0.8 (when metallic)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="comparison">
            <div class="viewport">
                <h3>CLIENT SIDE (CoinEditor.tsx)</h3>
                <div class="canvas-container" id="client-canvas"></div>
                <p><small>Camera Z: 6 | Fill: 0.8 | Ambient: 0.9 | Rim: 0.4 | <span class="highlight">Linear Tone Mapping</span></small></p>
            </div>
            
            <div class="viewport">
                <h3>SERVER SIDE (render-frames.ts)</h3>
                <div class="canvas-container" id="server-canvas"></div>
                <p><small>Camera Z: 2.8 | Fill: 0.6 | Ambient: 0.7 | Rim: 0.4 | <span class="highlight">Linear Tone Mapping</span></small></p>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-grid">
                <!-- Lighting Controls -->
                <div class="control-group">
                    <h4>Common Lighting</h4>
                    <div class="control-row">
                        <label>Light Color:</label>
                        <input type="color" id="lightColor" value="#cecece">
                    </div>
                    <div class="control-row">
                        <label>Hemisphere:</label>
                        <input type="range" id="hemiIntensity" min="0" max="2" step="0.1" value="0.45">
                        <span class="value" id="hemiValue">0.45</span>
                    </div>
                    <div class="control-row">
                        <label>Directional:</label>
                        <input type="range" id="dirIntensity" min="0" max="3" step="0.1" value="0.8">
                        <span class="value" id="dirValue">0.8</span>
                    </div>
                </div>
                
                <!-- Server Specific -->
                <div class="control-group">
                    <h4>Server Lighting (Adjustable)</h4>
                    <div class="control-row">
                        <label>Fill Light:</label>
                        <input type="range" id="serverFillIntensity" min="0" max="2" step="0.1" value="0.6">
                        <span class="value" id="serverFillValue">0.6</span>
                    </div>
                    <div class="control-row">
                        <label>Ambient:</label>
                        <input type="range" id="serverAmbientIntensity" min="0" max="2" step="0.1" value="0.7">
                        <span class="value" id="serverAmbientValue">0.7</span>
                    </div>
                    <div class="control-row">
                        <label>Tone Mapping:</label>
                        <input type="checkbox" id="serverToneMapping" checked>
                        <input type="range" id="serverToneMappingExposure" min="0" max="2" step="0.1" value="0.8">
                        <span class="value" id="serverToneMappingValue">0.8</span>
                    </div>
                </div>
                
                <!-- Materials -->
                <div class="control-group">
                    <h4>Material Properties</h4>
                    <div class="control-row">
                        <label>Fill Mode:</label>
                        <select id="fillMode">
                            <option value="solid" selected>Solid Color</option>
                            <option value="gradient">Gradient</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>Body Color:</label>
                        <input type="color" id="bodyColor" value="#cecece">
                    </div>
                    <div class="control-row">
                        <label>Gradient Start:</label>
                        <input type="color" id="gradientStart" value="#00eaff">
                    </div>
                    <div class="control-row">
                        <label>Gradient End:</label>
                        <input type="color" id="gradientEnd" value="#ee00ff">
                    </div>
                </div>
                
                <!-- Physical Properties -->
                <div class="control-group">
                    <h4>Physical Properties</h4>
                    <div class="control-row">
                        <label>Metallic:</label>
                        <input type="checkbox" id="metallic" checked>
                    </div>
                    <div class="control-row">
                        <label>Roughness:</label>
                        <input type="range" id="roughness" min="0" max="1" step="0.01" value="0.34">
                        <span class="value" id="roughnessValue">0.34</span>
                    </div>
                    <div class="control-row">
                        <label>Metalness:</label>
                        <input type="range" id="metalness" min="0" max="1" step="0.01" value="0.8">
                        <span class="value" id="metalnessValue">0.8</span>
                    </div>
                </div>
                
                <!-- Geometry -->
                <div class="control-group">
                    <h4>Geometry</h4>
                    <div class="control-row">
                        <label>Shape:</label>
                        <select id="coinShape">
                            <option value="thin">Thin</option>
                            <option value="normal" selected>Normal</option>
                            <option value="thick">Thick</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>Radial Segments:</label>
                        <input type="range" id="radialSegments" min="32" max="256" step="16" value="128">
                        <span class="value" id="radialValue">128</span>
                    </div>
                    <div class="control-row">
                        <label>Cap Segments:</label>
                        <input type="range" id="capSegments" min="8" max="64" step="4" value="32">
                        <span class="value" id="capValue">32</span>
                    </div>
                </div>
            </div>
            
            <div class="buttons">
                <button onclick="resetToClientDefaults()">Reset to Client Defaults</button>
                <button onclick="resetToServerDefaults()">Reset to Server Defaults</button>
                <button onclick="copyServerSettings()">Copy Server Settings Code</button>
            </div>
            
            <div class="stats">
                <div>Client FPS: <span id="clientFps">60</span></div>
                <div>Server FPS: <span id="serverFps">60</span></div>
                <div>Triangles: <span id="triangles">0</span></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let clientScene, clientCamera, clientRenderer, clientCoin, clientTurntable;
        let serverScene, serverCamera, serverRenderer, serverCoin, serverTurntable;
        let clientMaterials = {}, serverMaterials = {};
        let clientLights = {}, serverLights = {};
        let stats = { clientFps: 0, serverFps: 0, triangles: 0 };
        let lastTime = 0;
        let frameCount = { client: 0, server: 0 };

        function init() {
            initClientScene();
            initServerScene();
            setupControls();
            updateBothScenes();
            animate();
            console.log('Visual test initialized');
        }
        
        function initClientScene() {
            // CLIENT: Exact copy of CoinEditor.tsx setup
            clientScene = new THREE.Scene();
            clientScene.background = null;
            
            // CLIENT: Camera at z=6 (different from server)
            clientCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
            clientCamera.position.set(0, 0, 6);
            clientCamera.lookAt(0, 0, 0);
            
            // CLIENT: Renderer WITH tone mapping (NOW MATCHES SERVER)
            clientRenderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true,
                premultipliedAlpha: false
            });
            clientRenderer.setSize(400, 400);
            clientRenderer.setClearColor(0x000000, 0);
            clientRenderer.outputColorSpace = THREE.SRGBColorSpace;
            clientRenderer.toneMapping = THREE.LinearToneMapping; // NOW MATCHES SERVER
            clientRenderer.toneMappingExposure = 0.8; // NOW MATCHES SERVER
            
            document.getElementById('client-canvas').appendChild(clientRenderer.domElement);
            
            // CLIENT: Setup lights
            setupClientLights();
        }
        
        function initServerScene() {
            // SERVER: Exact copy of render-frames.ts setup
            serverScene = new THREE.Scene();
            serverScene.background = null;
            
            // SERVER: Camera at z=2.8 (different from client)
            serverCamera = new THREE.PerspectiveCamera(45, 1, 0.1, 100);
            serverCamera.position.set(0, 0, 2.8);
            serverCamera.lookAt(0, 0, 0);
            
            // SERVER: Renderer WITH tone mapping
            serverRenderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true,
                premultipliedAlpha: false
            });
            serverRenderer.setSize(400, 400);
            serverRenderer.setClearColor(0x000000, 0);
            serverRenderer.outputColorSpace = THREE.SRGBColorSpace;
            serverRenderer.toneMapping = THREE.LinearToneMapping; // SERVER SPECIFIC
            serverRenderer.toneMappingExposure = 0.8;
            
            document.getElementById('server-canvas').appendChild(serverRenderer.domElement);
            
            // SERVER: Setup lights
            setupServerLights();
        }
        
        function setupClientLights() {
            // CLIENT: EXACT copy from CoinEditor.tsx (lines 182-199)
            clientLights.hemi = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.45);
            clientScene.add(clientLights.hemi);
            
            clientLights.dir = new THREE.DirectionalLight(0xffffff, 0.8);
            clientLights.dir.position.set(3, 5, 2);
            clientScene.add(clientLights.dir);
            
            // CLIENT: Fill light 0.8 (NOT 0.6 like server)
            clientLights.fill = new THREE.DirectionalLight(0xffffff, 0.8);
            clientLights.fill.position.set(-2, -3, -1);
            clientScene.add(clientLights.fill);
            
            // CLIENT: Rim light 0.4
            clientLights.rim = new THREE.DirectionalLight(0xffffff, 0.4);
            clientLights.rim.position.set(-3, 1, 4);
            clientScene.add(clientLights.rim);
            
            // CLIENT: Ambient light 0.9 (NOT 0.7 like server)
            clientLights.ambient = new THREE.AmbientLight(0xffffff, 0.9);
            clientScene.add(clientLights.ambient);
        }
        
        function setupServerLights() {
            // SERVER: EXACT copy from render-frames.ts (lines 493-513)
            serverLights.hemi = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.45);
            serverScene.add(serverLights.hemi);
            
            serverLights.dir = new THREE.DirectionalLight(0xffffff, 0.8);
            serverLights.dir.position.set(3, 5, 2);
            serverScene.add(serverLights.dir);
            
            // SERVER: Fill light 0.6 (REDUCED from client's 0.8)
            serverLights.fill = new THREE.DirectionalLight(0xffffff, 0.6);
            serverLights.fill.position.set(-2, -3, -1);
            serverScene.add(serverLights.fill);
            
            // SERVER: Rim light 0.4
            serverLights.rim = new THREE.DirectionalLight(0xffffff, 0.4);
            serverLights.rim.position.set(-3, 1, 4);
            serverScene.add(serverLights.rim);
            
            // SERVER: Ambient light 0.7 (REDUCED from client's 0.9)
            serverLights.ambient = new THREE.AmbientLight(0xffffff, 0.7);
            serverScene.add(serverLights.ambient);
        }
        
        function createCoin(type) {
            const coinShapeValue = document.getElementById('coinShape').value;
            const radialSegments = parseInt(document.getElementById('radialSegments').value);
            const capSegments = parseInt(document.getElementById('capSegments').value);
            
            const R = 1.0;
            const T = 0.35;
            const shapeMap = { 'thin': 0.01, 'normal': 0.15, 'thick': 0.25 };
            const bulge = shapeMap[coinShapeValue];
            
            // CRITICAL DIFFERENCE: Client vs Server initial material setup
            let initialColor, initialMetalness, initialRoughness;
            
            if (type === 'client') {
                // CLIENT: Starts with bronze color like CoinEditor.tsx internal defaults
                initialColor = 0xcecece; // Bronze (internal CoinEditor default)
                initialMetalness = 1.0;   // Will be overridden by settings
                initialRoughness = 0.1;
            } else {
                // SERVER: Starts with gray like render-frames.ts
                initialColor = 0xcecece;  // Light gray (render-frames.ts default)  
                initialMetalness = 0.8;   // Fixed in render-frames.ts
                initialRoughness = 0.34;  // Fixed in render-frames.ts
            }
            
            const rimMat = new THREE.MeshStandardMaterial({
                color: initialColor,
                metalness: initialMetalness,
                roughness: initialRoughness,
                envMapIntensity: 1
            });
            const faceMat = rimMat.clone();
            
            if (type === 'client') {
                clientMaterials = { rim: rimMat, face: faceMat };
            } else {
                serverMaterials = { rim: rimMat, face: faceMat };
            }
            
            const cylinderGeometry = new THREE.CylinderGeometry(R, R, T, radialSegments, 1, true);
            const cylinder = new THREE.Mesh(cylinderGeometry, rimMat);
            
            const createFace = function(isTop) {
                const geometry = new THREE.SphereGeometry(
                    R, radialSegments, capSegments, 0, Math.PI * 2,
                    isTop ? 0 : Math.PI / 2, Math.PI / 2
                );
                geometry.scale(1, bulge / R, 1);
                geometry.translate(0, isTop ? T / 2 : -T / 2, 0);
                return new THREE.Mesh(geometry, faceMat);
            };
            
            const topFace = createFace(true);
            const bottomFace = createFace(false);
            
            const coinGroup = new THREE.Group();
            coinGroup.add(cylinder, topFace, bottomFace);
            coinGroup.rotation.x = Math.PI / 2;
            
            return coinGroup;
        }
        
        function setupControls() {
            const ranges = ['hemiIntensity', 'dirIntensity', 'serverFillIntensity', 'serverAmbientIntensity', 
                          'roughness', 'metalness', 'radialSegments', 'capSegments', 'serverToneMappingExposure'];
            
            ranges.forEach(function(id) {
                const element = document.getElementById(id);
                const valueId = id.replace('Intensity', 'Value').replace('Segments', 'Value').replace('Exposure', 'Value').replace('server', '');
                const valueSpan = document.getElementById(valueId);
                
                element.addEventListener('input', function() {
                    if (valueSpan) valueSpan.textContent = element.value;
                    updateBothScenes();
                });
            });
            
            ['lightColor', 'bodyColor', 'gradientStart', 'gradientEnd'].forEach(function(id) {
                document.getElementById(id).addEventListener('input', updateBothScenes);
            });
            
            ['fillMode', 'coinShape'].forEach(function(id) {
                document.getElementById(id).addEventListener('change', updateBothScenes);
            });
            
            ['metallic', 'serverToneMapping'].forEach(function(id) {
                document.getElementById(id).addEventListener('change', updateBothScenes);
            });
            
            // Initialize labels
            ranges.forEach(function(id) {
                const element = document.getElementById(id);
                const valueId = id.replace('Intensity', 'Value').replace('Segments', 'Value').replace('Exposure', 'Value').replace('server', '');
                const valueSpan = document.getElementById(valueId);
                if (valueSpan) valueSpan.textContent = element.value;
            });
        }
        
        function updateBothScenes() {
            updateClientScene();
            updateServerScene();
            updateStats();
        }
        
        function updateClientScene() {
            // CLIENT: Only color and intensity settings can change (like CoinEditor.tsx)
            const lightColor = document.getElementById('lightColor').value;
            const hemiIntensity = parseFloat(document.getElementById('hemiIntensity').value);
            const dirIntensity = parseFloat(document.getElementById('dirIntensity').value);
            
            clientLights.hemi.intensity = hemiIntensity;
            clientLights.dir.intensity = dirIntensity;
            clientLights.hemi.color.set(lightColor);
            clientLights.dir.color.set(lightColor);
            
            // CLIENT: These values are FIXED in CoinEditor.tsx (cannot be adjusted)
            // clientLights.fill.intensity = 0.8;  // FIXED
            // clientLights.rim.intensity = 0.4;   // FIXED  
            // clientLights.ambient.intensity = 0.9; // FIXED
            
            updateMaterials('client');
            recreateCoinIfNeeded('client');
        }
        
        function updateServerScene() {
            // SERVER: All lighting values can be adjusted (like render-frames.ts with user controls)
            const lightColor = document.getElementById('lightColor').value;
            const hemiIntensity = parseFloat(document.getElementById('hemiIntensity').value);
            const dirIntensity = parseFloat(document.getElementById('dirIntensity').value);
            const serverFillIntensity = parseFloat(document.getElementById('serverFillIntensity').value);
            const serverAmbientIntensity = parseFloat(document.getElementById('serverAmbientIntensity').value);
            
            serverLights.hemi.intensity = hemiIntensity;
            serverLights.dir.intensity = dirIntensity;
            serverLights.fill.intensity = serverFillIntensity;
            serverLights.rim.intensity = 0.4; // SERVER: Rim light is fixed at 0.4
            serverLights.ambient.intensity = serverAmbientIntensity;
            
            serverLights.hemi.color.set(lightColor);
            serverLights.dir.color.set(lightColor);
            
            // SERVER: Tone mapping controls (KEY DIFFERENCE from client)
            const serverToneMapping = document.getElementById('serverToneMapping').checked;
            const serverToneMappingExposure = parseFloat(document.getElementById('serverToneMappingExposure').value);
            
            serverRenderer.toneMapping = serverToneMapping ? THREE.LinearToneMapping : THREE.NoToneMapping;
            serverRenderer.toneMappingExposure = serverToneMappingExposure;
            
            updateMaterials('server');
            recreateCoinIfNeeded('server');
        }
        
        function updateMaterials(type) {
            const materials = type === 'client' ? clientMaterials : serverMaterials;
            if (!materials.rim || !materials.face) return;
            
            const fillMode = document.getElementById('fillMode').value;
            const bodyColor = document.getElementById('bodyColor').value;
            const gradientStart = document.getElementById('gradientStart').value;
            const gradientEnd = document.getElementById('gradientEnd').value;
            const metallic = document.getElementById('metallic').checked;
            const roughness = parseFloat(document.getElementById('roughness').value);
            const metalness = parseFloat(document.getElementById('metalness').value);
            
            // Apply fill mode (EXACTLY like CoinEditor.tsx and render-frames.ts)
            if (fillMode === 'solid') {
                materials.rim.color.set(bodyColor);
                materials.face.color.set(bodyColor);
                materials.rim.map = null;
                materials.face.map = null;
            } else {
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 256;
                const ctx = canvas.getContext('2d');
                
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, gradientStart);
                gradient.addColorStop(1, gradientEnd);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const texture = new THREE.CanvasTexture(canvas);
                texture.colorSpace = THREE.SRGBColorSpace;
                
                materials.rim.map = texture;
                materials.face.map = texture.clone();
                materials.rim.color.set('#ffffff');
                materials.face.color.set('#ffffff');
            }
            
            // CRITICAL DIFFERENCE: Client vs Server metalness handling
            if (type === 'client') {
                // CLIENT: CoinEditor.tsx uses metallic ? 1 : 0.1 (FULL metallic when enabled!)
                materials.rim.metalness = metallic ? 1 : 0.1;
                materials.face.metalness = metallic ? 1 : 0.1;
                materials.rim.roughness = metallic ? 0.34 : 0.7; // Estimated from CoinEditor behavior
                materials.face.roughness = metallic ? 0.34 : 0.7;
            } else {
                // SERVER: render-frames.ts uses metallic ? 0.8 : 0.5 (different values!)
                materials.rim.metalness = metallic ? 0.8 : 0.5;
                materials.face.metalness = metallic ? 0.8 : 0.5;
                materials.rim.roughness = metallic ? 0.34 : 0.7;
                materials.face.roughness = metallic ? 0.34 : 0.7;
            }
            
            materials.rim.needsUpdate = true;
            materials.face.needsUpdate = true;
        }
        
        function recreateCoinIfNeeded(type) {
            if (type === 'client') {
                if (clientTurntable) clientScene.remove(clientTurntable);
                clientCoin = createCoin('client');
                clientTurntable = new THREE.Group();
                clientTurntable.add(clientCoin);
                clientScene.add(clientTurntable);
            } else {
                if (serverTurntable) serverScene.remove(serverTurntable);
                serverCoin = createCoin('server');
                serverTurntable = new THREE.Group();
                serverTurntable.add(serverCoin);
                serverScene.add(serverTurntable);
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            const currentTime = performance.now();
            
            if (clientTurntable) clientTurntable.rotation.y += 0.01;
            if (serverTurntable) serverTurntable.rotation.y += 0.01;
            
            frameCount.client++;
            frameCount.server++;
            if (currentTime - lastTime >= 1000) {
                stats.clientFps = Math.round(frameCount.client * 1000 / (currentTime - lastTime));
                stats.serverFps = Math.round(frameCount.server * 1000 / (currentTime - lastTime));
                document.getElementById('clientFps').textContent = stats.clientFps;
                document.getElementById('serverFps').textContent = stats.serverFps;
                frameCount.client = 0;
                frameCount.server = 0;
                lastTime = currentTime;
            }
            
            if (clientRenderer && clientScene && clientCamera) {
                clientRenderer.render(clientScene, clientCamera);
            }
            if (serverRenderer && serverScene && serverCamera) {
                serverRenderer.render(serverScene, serverCamera);
            }
        }
        
        function updateStats() {
            let triangles = 0;
            if (clientScene) {
                clientScene.traverse(function(object) {
                    if (object.geometry) {
                        const positions = object.geometry.attributes.position;
                        if (positions) {
                            triangles += positions.count / 3;
                        }
                    }
                });
            }
            stats.triangles = Math.round(triangles);
            document.getElementById('triangles').textContent = stats.triangles.toLocaleString();
        }
        
        function resetToClientDefaults() {
            // Reset to App.tsx + CoinEditor.tsx actual defaults
            document.getElementById('lightColor').value = '#cecece';        // App.tsx default
            document.getElementById('hemiIntensity').value = '0.45';
            document.getElementById('dirIntensity').value = '0.8';
            document.getElementById('serverFillIntensity').value = '0.8';    // CLIENT: Fixed at 0.8
            document.getElementById('serverAmbientIntensity').value = '0.9'; // CLIENT: Fixed at 0.9
            document.getElementById('fillMode').value = 'solid';             // App.tsx starts with solid
            document.getElementById('bodyColor').value = '#cecece';          // App.tsx default
            document.getElementById('gradientStart').value = '#00eaff';      // App.tsx default
            document.getElementById('gradientEnd').value = '#ee00ff';        // App.tsx default
            document.getElementById('metallic').checked = true;              // App.tsx default
            document.getElementById('roughness').value = '0.34';
            document.getElementById('metalness').value = '1.0';              // CLIENT: Uses 1.0 when metallic!
            document.getElementById('coinShape').value = 'normal';
            document.getElementById('radialSegments').value = '128';
            document.getElementById('capSegments').value = '32';
            document.getElementById('serverToneMapping').checked = false;    // CLIENT: NO TONE MAPPING
            document.getElementById('serverToneMappingExposure').value = '1.0';
            
            setupControls();
            updateBothScenes();
        }
        
        function resetToServerDefaults() {
            // Reset to render-frames.ts actual defaults
            document.getElementById('lightColor').value = '#cecece';         // Matches client
            document.getElementById('hemiIntensity').value = '0.45';
            document.getElementById('dirIntensity').value = '0.8';
            document.getElementById('serverFillIntensity').value = '0.6';     // SERVER: Reduced lighting
            document.getElementById('serverAmbientIntensity').value = '0.7';  // SERVER: Reduced lighting
            document.getElementById('fillMode').value = 'solid';              // Same as client start
            document.getElementById('bodyColor').value = '#cecece';           // render-frames.ts default
            document.getElementById('gradientStart').value = '#00eaff';
            document.getElementById('gradientEnd').value = '#ee00ff';
            document.getElementById('metallic').checked = true;
            document.getElementById('roughness').value = '0.34';
            document.getElementById('metalness').value = '0.8';               // SERVER: Uses 0.8 when metallic
            document.getElementById('coinShape').value = 'normal';
            document.getElementById('radialSegments').value = '128';
            document.getElementById('capSegments').value = '32';
            document.getElementById('serverToneMapping').checked = true;      // SERVER: WITH TONE MAPPING
            document.getElementById('serverToneMappingExposure').value = '0.8';
            
            setupControls();
            updateBothScenes();
        }
        
        function copyServerSettings() {
            const serverSettings = {
                fillLightIntensity: parseFloat(document.getElementById('serverFillIntensity').value),
                ambientLightIntensity: parseFloat(document.getElementById('serverAmbientIntensity').value),
                toneMapping: document.getElementById('serverToneMapping').checked,
                toneMappingExposure: parseFloat(document.getElementById('serverToneMappingExposure').value),
                hemiIntensity: parseFloat(document.getElementById('hemiIntensity').value),
                dirIntensity: parseFloat(document.getElementById('dirIntensity').value),
                roughness: parseFloat(document.getElementById('roughness').value),
                metalness: parseFloat(document.getElementById('metalness').value),
                radialSegments: parseInt(document.getElementById('radialSegments').value),
                capSegments: parseInt(document.getElementById('capSegments').value)
            };
            
            const codeSnippet = '// Apply these settings to render-frames.ts:\n\n' +
                '// Lighting (around line 503-513)\n' +
                'const fillLight = new THREE.DirectionalLight(0xffffff, ' + serverSettings.fillLightIntensity + ');\n' +
                'const broadLight = new THREE.AmbientLight(0xffffff, ' + serverSettings.ambientLightIntensity + ');\n\n' +
                '// Renderer tone mapping (around line 361-363)\n' +
                (serverSettings.toneMapping ? 
                  'renderer.toneMapping = THREE.LinearToneMapping;\nrenderer.toneMappingExposure = ' + serverSettings.toneMappingExposure + ';' : 
                  'renderer.toneMapping = THREE.NoToneMapping;') + '\n\n' +
                '// Geometry segments (around line 408-409)\n' +
                'const radialSegments = ' + serverSettings.radialSegments + ';\n' +
                'const capSegments = ' + serverSettings.capSegments + ';\n\n' +
                '// Material properties (around line 415-416)\n' +
                'roughness: ' + serverSettings.roughness + ',\n' +
                'metalness: ' + serverSettings.metalness + ',';
            
            navigator.clipboard.writeText(codeSnippet).then(function() {
                alert('Server settings code snippet copied to clipboard!\n\nYou can now paste this into render-frames.ts to apply the changes.');
            });
        }
        
        window.addEventListener('load', init);
    </script>
</body>
</html>
